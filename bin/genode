#!/usr/bin/env node

"use strict";

var fs = require('fs'),
    os = require('os'),
    mkdirp = require('mkdirp'),
    program = require('commander'),
    pkg = require('../package.json'),
    version = pkg.version;

program
  .version(version)
  .usage('<project>')
  .option('-c, --coffeescript', 'enable coffeescript support')
  .parse(process.argv);

if (program.args.length !== 1) {
  console.log(program.help());
  return;
}

var project = program.args[0];
var unproject = project.replace(/-/g, '_');
var eol = 'win32' === os.platform() ? '\r\n' : '\n';
var ext = program.coffeescript ? '.coffee' : '.js';

var directories = ['lib'];
var files = {};
var dependencies = {};

if (program.coffeescript) {
  dependencies['coffee-script'] = '*';
}

files['.gitignore'] = [
  '.DS_store',
  'lib-cov',
  '*.seed',
  '*.log',
  '*.csv',
  '*.dat',
  '*.out',
  '*.pid',
  '*.swp',
  '*.swo',
  '*.gz',
  '',
  'pids',
  'logs',
  'results',
  '',
  'npm-debug.log',
  'node_modules/'
].join(eol);

files['.npmignore'] = [
  '.DS_Store',
  'lib-cov',
  'coverage.html',
  '.git*',
  'docs/',
  'examples/',
  'support/',
  'test/',
  'testing.js'
].join(eol);

files['index.js'] = [
  'module.exports = require(\'./lib/' + unproject + '\');'
].join(eol);

if (program.coffeescript) {
  var temp = files['index.js'];
  files['index.js'] = [
    'require("coffee-script");',
    temp
  ].join(eol);
}

files['package.json'] = JSON.stringify({
  name: project,
  version: '0.0.1',
  description: 'todo',
  author: 'todo',
  main: 'index.js',
  dependencies: dependencies
}, null, 4);

files['README.md'] = [
  '# ' + project
].join(eol);

files['lib/' + unproject + ext] = [
  ''
].join(eol);

directories.forEach(function(subdir) {
  mkdirp.sync(project + '/' + subdir, '0755', function(err) {
    if (err) {
      throw err;
    }
  });
});

Object.keys(files).forEach(function(file) {
  fs.writeFile(project + '/' + file, files[file], function(err) {
    if (err) {
      throw err;
    }
  });
});
